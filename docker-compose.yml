# ====================================================================
# Docker Compose for the ENMS Project (Corrected Ports)
# Version: 1.1
# ====================================================================

version: '3.8'

services:
  # -------------------------------------------------
  # 1. PostgreSQL Database with TimescaleDB Extension
  # -------------------------------------------------
  postgres:
    image: timescale/timescaledb:latest-pg16
    container_name: enms_postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=reg_ml
      - POSTGRES_USER=reg_ml
      - POSTGRES_PASSWORD=raptorblingx
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/db_init:/docker-entrypoint-initdb.d
    ports:
      # Exposes the database on the standard port to the host machine.
      - "5432:5432"

  # -------------------------------------------------
  # 2. Node-RED Processing Engine
  # -------------------------------------------------
  nodered:
    image: nodered/node-red:latest
    container_name: enms_nodered
    restart: unless-stopped
    ports:
      # Exposes the Node-RED editor and API to the host machine.
      - "1880:1880"
    volumes:
      - ./node-red:/data
    depends_on:
      - postgres

  # -------------------------------------------------
  # 3. Grafana Visualization Dashboard
  # -------------------------------------------------
  grafana:
    image: grafana/grafana:latest
    container_name: enms_grafana
    restart: unless-stopped
    ports:
      # Exposes the Grafana web interface to the host machine.
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - postgres

  # -------------------------------------------------
  # 4. Web Server (Nginx) for Frontend & API Proxy
  # -------------------------------------------------
  web_server:
    image: nginx:latest
    container_name: enms_web_server
    restart: unless-stopped
    ports:
      # --- THIS IS THE FIX ---
      # Exposes the main application on the standard HTTP port 80.
      - "80:80"
    volumes:
      # Mounts the main config file
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      # Mounts the directory containing our site-specific config (default.conf)
      - ./nginx/conf.d:/etc/nginx/conf.d
      # Mounts your frontend code
      - ./frontend:/usr/share/nginx/html
      # Mounts your images
      - ./artistic-resources:/usr/share/nginx/html/artistic-resources
    depends_on:
      - nodered

# Define the named volumes for persistent data storage
volumes:
  postgres_data:
  grafana_data:
