# ====================================================================
# FINAL Docker Compose for the ENMS Project
# Version: 2.0 (Definitive)
# ====================================================================

version: '3.8'

services:
   # 1. PostgreSQL Database
  postgres:
    # THE FINAL, VERIFIED IMAGE NAME AND TAG
    image: timescale/timescaledb:latest-pg16
    container_name: enms_postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=reg_ml
      - POSTGRES_USER=reg_ml
      - POSTGRES_PASSWORD=raptorblingx
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/db_init:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U reg_ml -d reg_ml"]
      interval: 5s
      timeout: 5s
      retries: 5


  # 2. Node-RED Service
  nodered:
    build:
      context: .
      dockerfile: ./node-red/Dockerfile
    container_name: enms_nodered
    restart: unless-stopped
    ports:
      - "1880:1880"
    volumes:
      - ./node-red:/data            # make /data persistent & match repo (flows_docker.json lives here)
    environment:
      - NODE_RED_CREDENTIAL_SECRET=enms-prod-secret-2025
      - FLOWS=flows_docker.json     # tells Node-RED to load /data/flows_docker.json
    depends_on:
      - postgres
      - python_api


  # 3. Grafana Service
  grafana:
    image: grafana/grafana:latest
    container_name: enms_grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_INSTALL_PLUGINS=grafana-mqtt-datasource
      - GF_SECURITY_ALLOW_EMBEDDING=true
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    #  - GF_SERVER_ROOT_URL=%(protocol)s://%(domain)s/grafana
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards
      # This is the correct path for the dashboard files
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      postgres:
        condition: service_healthy

  # 4. Python API Service
  python_api:
    build:
      context: ./python-api
    container_name: enms_python_api
    restart: unless-stopped
    env_file:
      - .env.docker
    volumes:
      - ./generated_pdfs:/usr/src/app/generated_pdfs
    depends_on:
      - postgres

  # 5. Web Server (Nginx)
  web_server:
    image: nginx:latest
    container_name: enms_web_server
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./frontend:/usr/share/nginx/html
      - ./artistic-resources:/usr/share/nginx/html/artistic-resources
    depends_on:
      - nodered
      - python_api

# Define named volumes for persistent data
volumes:
  postgres_data:
  grafana_data:
